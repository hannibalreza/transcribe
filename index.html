<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>N8N File Uploader</title>
    <link href="https://releases.transloadit.com/uppy/v3.6.1/uppy.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
      :root {
        --primary: #9E1A59;
        --primary-dark: #871748;
        --secondary: #1B0D1B;
        --accent: #BE2E70;
        --light: #F8F8FB;
        --gray: #EBEEF5;
        --text: #252135;
        --text-light: #6e617f;
      }
      
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      html, body {
        height: 100%;
      }
      
      body {
        background-color: var(--light);
        font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        color: var(--text);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 40px 20px;
      }
      
      .app-container {
        width: 100%;
        max-width: 900px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      
      header {
        margin-bottom: 40px;
        text-align: center;
      }
      
      h1 {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--secondary);
        margin-bottom: 10px;
      }
      
      h2 {
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--secondary);
        margin-bottom: 20px;
      }
      
      .subtitle {
        font-size: 1.1rem;
        color: var(--text-light);
        max-width: 600px;
        text-align: center;
      }
      
      #drag-drop-area {
        width: 100%;
        margin-bottom: 40px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 30px rgba(15, 17, 51, 0.08);
      }
      
      /* Override Uppy styles for more modern look */
      .uppy-Dashboard-inner {
        border: 2px dashed var(--gray) !important;
        background-color: white !important;
      }
      
      .uppy-Dashboard-AddFiles-title {
        color: var(--text) !important;
        font-family: 'Poppins', sans-serif !important;
        font-weight: 500 !important;
      }
      
      .uppy-Dashboard-browse {
        color: var(--primary) !important;
      }
      
      .uppy-Dashboard-dropFilesHereHint {
        border-radius: 8px !important;
        background-color: var(--gray) !important;
        color: var(--text-light) !important;
      }
      
      .uppy-Dashboard-Item-previewInnerWrap {
        border-radius: 8px !important;
      }
      
      .uppy-Dashboard-Item-name {
        font-family: 'Poppins', sans-serif !important;
      }
      
      .uppy-Dashboard-Item-statusSize {
        font-family: 'Poppins', sans-serif !important;
      }
      
      #uploaded-files {
        width: 100%;
        background-color: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 8px 30px rgba(15, 17, 51, 0.08);
      }
      
      #no-files {
        color: var(--text-light);
        text-align: center;
        padding: 20px;
      }
      
      .file-item {
        margin-bottom: 25px;
        padding-bottom: 25px;
        border-bottom: 1px solid var(--gray);
      }
      
      .file-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      
      .file-name {
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 1.1rem;
        color: var(--secondary);
      }
      
      .file-size {
        color: var(--text-light);
        margin-bottom: 12px;
        font-size: 0.9rem;
      }
      
      .file-url {
        word-break: break-all;
        font-family: monospace;
        background-color: var(--gray);
        padding: 12px;
        border-radius: 8px;
        margin: 12px 0;
        font-size: 0.9rem;
      }
      
      .n8n-trigger {
        margin-top: 15px;
      }
      
      .n8n-trigger button {
        background-color: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        cursor: pointer;
        font-weight: 500;
        font-family: 'Poppins', sans-serif;
        font-size: 0.95rem;
        transition: all 0.2s ease;
      }
      
      .n8n-trigger button:hover {
        background-color: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(67, 70, 177, 0.2);
      }
      
      .n8n-trigger button:disabled {
        background-color: var(--gray);
        color: var(--text-light);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      
      .status-message {
        margin-top: 12px;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 0.9rem;
      }
      
      .success {
        background-color: rgba(72, 187, 120, 0.1);
        color: #2f855a;
      }
      
      .error {
        background-color: rgba(245, 101, 101, 0.1);
        color: #c53030;
      }
      
      .processing {
        background-color: rgba(66, 153, 225, 0.1);
        color: #2b6cb0;
      }
      
      /* Responsive adjustments */
      @media (max-width: 768px) {
        body {
          padding: 20px 15px;
        }
        
        h1 {
          font-size: 2rem;
        }
        
        h2 {
          font-size: 1.5rem;
        }
        
        #uploaded-files {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <header>
        <h1>File Uploader</h1>
        <p class="subtitle">Upload your files to Supabase storage and trigger N8N workflows with ease</p>
      </header>
      
      <div id="drag-drop-area"></div>
      
      <div id="uploaded-files">
        <h2>Uploaded Files</h2>
        <p id="no-files">No files uploaded yet.</p>
        <div id="file-list"></div>
      </div>
    </div>

    <script type="module">
      import {
        Uppy,
        Dashboard,
        Tus,
      } from 'https://releases.transloadit.com/uppy/v3.6.1/uppy.min.mjs'

      // Your Supabase configuration
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwY2lmbHNvb3JzY2Via2h3bWdhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwMTY0NDQsImV4cCI6MjA1OTU5MjQ0NH0.N_O_a843qVPLVIt3DTKzsbtFY2kHLU0JOWAL39hu2NA'
      const SUPABASE_PROJECT_ID = 'cpciflsoorscebkhwmga'
      const STORAGE_BUCKET = 'merluno'
      const BEARER_TOKEN = SUPABASE_ANON_KEY // Using the anon key for public uploads
      
      // N8N webhook configuration - not visible to end users in the UI
      const N8N_WEBHOOK_URL = 'https://accounts-da.app.n8n.cloud/webhook/upload-audio'

      // You can specify a folder within your bucket if needed
      const folder = ''
      const supabaseStorageURL = `https://${SUPABASE_PROJECT_ID}.supabase.co/storage/v1/upload/resumable`
      const fileList = document.getElementById('file-list')
      const noFilesMsg = document.getElementById('no-files')

      var uppy = new Uppy({
        restrictions: {
          maxFileSize: 100 * 1024 * 1024, // 100MB limit
          maxNumberOfFiles: 10,
        },
        autoProceed: false
      })
        .use(Dashboard, {
          inline: true,
          target: '#drag-drop-area',
          showProgressDetails: true,
          proudlyDisplayPoweredByUppy: false,
          height: 360,
        })
        .use(Tus, {
          endpoint: supabaseStorageURL,
          headers: {
            authorization: `Bearer ${BEARER_TOKEN}`,
            apikey: SUPABASE_ANON_KEY,
            'x-upsert': 'true', // Set to true to overwrite existing files
          },
          uploadDataDuringCreation: true,
          chunkSize: 6 * 1024 * 1024, // Must be 6MB for Supabase
          allowedMetaFields: ['bucketName', 'objectName', 'contentType', 'cacheControl'],
          onError: function (error) {
            console.error('Upload failed:', error)
          },
        })

      uppy.on('file-added', (file) => {
        const supabaseMetadata = {
          bucketName: STORAGE_BUCKET,
          objectName: folder ? `${folder}/${file.name}` : file.name,
          contentType: file.type,
        }

        file.meta = {
          ...file.meta,
          ...supabaseMetadata,
        }
      })

      uppy.on('upload-success', (file, response) => {
        // Hide the "no files" message
        noFilesMsg.style.display = 'none'

        // Calculate the Supabase public URL for the file
        const publicUrl = `https://${SUPABASE_PROJECT_ID}.supabase.co/storage/v1/object/public/${STORAGE_BUCKET}/${file.meta.objectName}`
        
        // Create an element to display the file info
        const fileItem = document.createElement('div')
        fileItem.className = 'file-item'
        
        const fileName = document.createElement('div')
        fileName.className = 'file-name'
        fileName.textContent = file.name
        
        const fileSize = document.createElement('div')
        fileSize.className = 'file-size'
        fileSize.textContent = `Size: ${formatBytes(file.size)}`
        
        const fileUrl = document.createElement('div')
        fileUrl.className = 'file-url'
        fileUrl.textContent = publicUrl
        
        // Create a button to trigger N8N workflow
        const n8nTrigger = document.createElement('div')
        n8nTrigger.className = 'n8n-trigger'
        
        const triggerBtn = document.createElement('button')
        triggerBtn.textContent = 'Trigger N8N Workflow'
        triggerBtn.onclick = function() {
          triggerN8nWorkflow(publicUrl, file.name, triggerBtn, n8nTrigger)
        }
        
        n8nTrigger.appendChild(triggerBtn)
        
        fileItem.appendChild(fileName)
        fileItem.appendChild(fileSize)
        fileItem.appendChild(fileUrl)
        fileItem.appendChild(n8nTrigger)
        
        fileList.appendChild(fileItem)
      })

      // Function to format bytes to human-readable format
      function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes'
        
        const k = 1024
        const dm = decimals < 0 ? 0 : decimals
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB']
        
        const i = Math.floor(Math.log(bytes) / Math.log(k))
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i]
      }

      // Function to trigger N8N workflow with the file URL
      function triggerN8nWorkflow(fileUrl, fileName, buttonElement, containerElement) {
        // Disable button to prevent multiple submissions
        buttonElement.disabled = true
        buttonElement.textContent = 'Sending...'
        
        // Add status message element
        const statusMsg = document.createElement('div')
        statusMsg.className = 'status-message processing'
        statusMsg.textContent = 'Processing request...'
        containerElement.appendChild(statusMsg)
        
        // Send request to N8N webhook
        fetch(N8N_WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            fileUrl: fileUrl,
            fileName: fileName,
            timestamp: new Date().toISOString()
          })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok')
          }
          return response.json()
        })
        .then(data => {
          console.log('N8N workflow triggered successfully:', data)
          statusMsg.className = 'status-message success'
          statusMsg.textContent = 'Workflow triggered successfully!'
          buttonElement.textContent = 'Workflow Triggered'
        })
        .catch(error => {
          console.error('Error triggering N8N workflow:', error)
          statusMsg.className = 'status-message error'
          statusMsg.textContent = 'Error triggering workflow. Please try again.'
          buttonElement.disabled = false
          buttonElement.textContent = 'Retry Trigger N8N Workflow'
        })
      }
    </script>
  </body>
</html>
